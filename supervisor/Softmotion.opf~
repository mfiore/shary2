;; -*-Lisp-*-
;;author: Michelangelo Fiore
;;This module handles Softmotion requestes


(
 (defop |moveArm|
   :invocation(!(Softmotion.moveArm @armId $report))
   :documentation "Executes the trajectory calculated previously by MHP"
   :body (
	  (!(= @parameters 
	       (PR2SM_TRACK_STR 
		(posterName 
		 (name  "mhpArmTraj"))	     
		(trackMode PR2SM_TRACK_POSTER )
		(robotPart (VAL @armId)))))

	  
	  (!(GenomInterface.handleRequest  PR2SOFTMOTION PR2SOFTMOTION_TRACKQ (Softmotion.stop moveArm) (Robot.isMovingArm (VAL @armId) TRUE) (Robot.isMovingArm (VAL @armId) FALSE) 300 (VAL @parameters) $report))
	  
	  )
   
   )

 (defop |moveHead|
   :invocation(Softmotion.moveHead @x @y @z $report)
   :documentation "Moves the head of the robot"
   :body  (
	   (!(= @parameters 
		(PR2SM_xyzHead 
		 (x  (VAL @x))
		 (y  (VAL @y))
		 (z  (VAL @z))
		 (frame  "/map")))
	     )
	   
	   (!(GenomInterface.handleRequest PR2SOFTMOTION PR2SOFTMOTION_MOVEHEAD (Softmotion.stop moveHead) (Robot.isMovingHead TRUE) (Robot.isMovingHead FALSE) 300 (VAL @parameters) $report))
	   
	   )
   )

 (defop |stop|
   :invocation (Softmotion.stop $report)
   :documentation "Stops the robot"
   :body (
	  (!(GenomInterface.handleRequest PR2SOFTMOTION PR2SOFTMOTION_STOP FALSE FALSE FALSE 300  @parameters $report))
	  (=> (Robot.isMovingHead FALSE))
	  (=> (Robot.isMovingArm MHP_RIGHT_ARM FALSE))
	  (=> (Robot.isMovingArm MHP_LEFT_ARM FALSE))
	  (=> (Robot.isMoving FALSE))
	  )
   )
 
 (defop |useGripper|
   :invocation (Softmotion.useGripper @state $report)
   :documentation "opens or closes the gripper of the robot"
   :body (
	  (!(= @parameters (PR2SM_gripperGrabRelease (VAL @state))))
	  (IF(?(EQUAL @state ROPEN))
	     (!(= @stopFact (Robot.rightGripper OPEN)))
	     
	     ELSEIF(?(EQUAL @state RCLOSE))
	     (!(= @stopFact (Robot.rightGripper CLOSE)))

	     ELSEIF(?(EQUAL @state LOPEN))
	     (!(= @stopFact (Robot.leftGripper OPEN)))

	     ELSEIF(?(EQUAL @state LCLOSE))
	     (!(= @stopFact (Robot.leftGripper CLOSE)))
	     )

	     
	     (!(GenomInterface.handleRequest PR2SOFTMOTION PR2SOFTMOTION_GRIPPERGRABRELEASE FALSE FALSE (VAL @stopFact) 300  @parameters $report)) 
	  
	  )
   )

 )
